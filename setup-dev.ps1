# Script de Setup para Ambiente de Desenvolvimento - Windows PowerShell
# Este script configura todo o ambiente necess√°rio para desenvolvimento local

param(
    [switch]$SkipDocker,
    [switch]$SkipNode,
    [switch]$SkipGit,
    [switch]$Force
)

Write-Host "üöÄ Configurando ambiente de desenvolvimento ENSO..." -ForegroundColor Green
Write-Host "==================================================" -ForegroundColor Green

# Fun√ß√£o para verificar se um comando existe
function Test-Command($cmdname) {
    return [bool](Get-Command -Name $cmdname -ErrorAction SilentlyContinue)
}

# Fun√ß√£o para executar comando com verifica√ß√£o de erro
function Invoke-CommandWithCheck($command, $description) {
    Write-Host "üìã $description..." -ForegroundColor Yellow
    try {
        Invoke-Expression $command
        if ($LASTEXITCODE -ne 0) {
            throw "Comando falhou com c√≥digo $LASTEXITCODE"
        }
        Write-Host "‚úÖ $description conclu√≠do" -ForegroundColor Green
    }
    catch {
        Write-Host "‚ùå Erro em $description : $_" -ForegroundColor Red
        return $false
    }
    return $true
}

# 1. Verificar e instalar Git
if (-not $SkipGit) {
    Write-Host "`nüîç Verificando Git..." -ForegroundColor Cyan
    if (-not (Test-Command "git")) {
        Write-Host "üì• Git n√£o encontrado. Instalando..." -ForegroundColor Yellow
        Write-Host "Por favor, baixe e instale o Git de: https://git-scm.com/download/win" -ForegroundColor Yellow
        Write-Host "Ap√≥s a instala√ß√£o, execute este script novamente." -ForegroundColor Yellow
        exit 1
    } else {
        $gitVersion = git --version
        Write-Host "‚úÖ Git encontrado: $gitVersion" -ForegroundColor Green
    }
}

# 2. Verificar e instalar Docker Desktop
if (-not $SkipDocker) {
    Write-Host "`nüîç Verificando Docker..." -ForegroundColor Cyan
    if (-not (Test-Command "docker")) {
        Write-Host "üì• Docker n√£o encontrado. Instalando..." -ForegroundColor Yellow
        Write-Host "Por favor, baixe e instale o Docker Desktop de: https://www.docker.com/products/docker-desktop" -ForegroundColor Yellow
        Write-Host "Ap√≥s a instala√ß√£o, execute este script novamente." -ForegroundColor Yellow
        exit 1
    } else {
        $dockerVersion = docker --version
        Write-Host "‚úÖ Docker encontrado: $dockerVersion" -ForegroundColor Green
        
        # Verificar se o Docker est√° rodando
        try {
            docker info | Out-Null
            Write-Host "‚úÖ Docker est√° rodando" -ForegroundColor Green
        }
        catch {
            Write-Host "‚ùå Docker n√£o est√° rodando. Por favor, inicie o Docker Desktop." -ForegroundColor Red
            exit 1
        }
    }
}

# 3. Verificar e instalar Node.js
if (-not $SkipNode) {
    Write-Host "`nüîç Verificando Node.js..." -ForegroundColor Cyan
    if (-not (Test-Command "node")) {
        Write-Host "üì• Node.js n√£o encontrado. Instalando..." -ForegroundColor Yellow
        Write-Host "Por favor, baixe e instale o Node.js de: https://nodejs.org/" -ForegroundColor Yellow
        Write-Host "Ap√≥s a instala√ß√£o, execute este script novamente." -ForegroundColor Yellow
        exit 1
    } else {
        $nodeVersion = node --version
        $npmVersion = npm --version
        Write-Host "‚úÖ Node.js encontrado: $nodeVersion" -ForegroundColor Green
        Write-Host "‚úÖ npm encontrado: $npmVersion" -ForegroundColor Green
    }
}

# 4. Criar arquivo .env para desenvolvimento
Write-Host "`nüìù Criando arquivo .env para desenvolvimento..." -ForegroundColor Cyan
$envContent = @"
# Configura√ß√µes do Banco de Dados
DATABASE_URL=postgresql://enso_user:enso_password_123@localhost:5432/enso_db_dev

# Configura√ß√µes de Autentica√ß√£o
JWT_SECRET=enso-jwt-secret-key-2024-development-local
SESSION_SECRET=enso-session-secret-2024-local

# Configura√ß√µes do Servidor
PORT=5002
NODE_ENV=development
HOST=0.0.0.0

# Configura√ß√µes do Gemini AI (Severino)
GEMINI_API_KEY=your-gemini-api-key-here

# Configura√ß√µes de Upload
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760

# Configura√ß√µes de Email (opcional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# Configura√ß√µes de Log
LOG_LEVEL=debug

# Configura√ß√µes do Redis
REDIS_URL=redis://localhost:6379

# Configura√ß√µes do Supabase Local
SUPABASE_URL=http://localhost:5433
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Configura√ß√µes de CORS
CORS_ORIGIN=http://localhost:3000
"@

$envContent | Out-File -FilePath ".env" -Encoding UTF8
Write-Host "‚úÖ Arquivo .env criado" -ForegroundColor Green

# 5. Criar arquivo .env para o client
Write-Host "`nüìù Criando arquivo .env para o client..." -ForegroundColor Cyan
$clientEnvContent = @"
VITE_API_URL=http://localhost:5002
VITE_SUPABASE_URL=http://localhost:5433
VITE_SUPABASE_ANON_KEY=your-anon-key
NODE_ENV=development
"@

$clientEnvContent | Out-File -FilePath "client/.env" -Encoding UTF8
Write-Host "‚úÖ Arquivo client/.env criado" -ForegroundColor Green

# 6. Instalar depend√™ncias do backend
Write-Host "`nüì¶ Instalando depend√™ncias do backend..." -ForegroundColor Cyan
if (Test-Path "package.json") {
    npm install
    Write-Host "‚úÖ Depend√™ncias do backend instaladas" -ForegroundColor Green
} else {
    Write-Host "‚ùå package.json n√£o encontrado no diret√≥rio raiz" -ForegroundColor Red
}

# 7. Instalar depend√™ncias do frontend
Write-Host "`nüì¶ Instalando depend√™ncias do frontend..." -ForegroundColor Cyan
if (Test-Path "client/package.json") {
    Set-Location client
    npm install
    Set-Location ..
    Write-Host "‚úÖ Depend√™ncias do frontend instaladas" -ForegroundColor Green
} else {
    Write-Host "‚ùå package.json n√£o encontrado no diret√≥rio client" -ForegroundColor Red
}

# 8. Criar diret√≥rios necess√°rios
Write-Host "`nüìÅ Criando diret√≥rios necess√°rios..." -ForegroundColor Cyan
$directories = @("uploads", "logs", "client/dist")
foreach ($dir in $directories) {
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
        Write-Host "‚úÖ Diret√≥rio $dir criado" -ForegroundColor Green
    }
}

# 9. Configurar Docker Compose
Write-Host "`nüê≥ Configurando Docker Compose..." -ForegroundColor Cyan
if (Test-Path "docker-compose.dev.yml") {
    Write-Host "‚úÖ docker-compose.dev.yml encontrado" -ForegroundColor Green
} else {
    Write-Host "‚ùå docker-compose.dev.yml n√£o encontrado" -ForegroundColor Red
}

# 10. Criar script de inicializa√ß√£o r√°pida
Write-Host "`nüìù Criando script de inicializa√ß√£o r√°pida..." -ForegroundColor Cyan
$startScript = @"
# Script de inicializa√ß√£o r√°pida do ambiente de desenvolvimento
Write-Host "üöÄ Iniciando ambiente de desenvolvimento ENSO..." -ForegroundColor Green

# Parar containers existentes
docker-compose -f docker-compose.dev.yml down

# Iniciar todos os servi√ßos
docker-compose -f docker-compose.dev.yml up -d

Write-Host "`n‚è≥ Aguardando servi√ßos iniciarem..." -ForegroundColor Yellow
Start-Sleep -Seconds 10

Write-Host "`nüåê Servi√ßos dispon√≠veis:" -ForegroundColor Green
Write-Host "   Frontend: http://localhost:3000" -ForegroundColor Cyan
Write-Host "   Backend:  http://localhost:5002" -ForegroundColor Cyan
Write-Host "   Adminer:  http://localhost:8080" -ForegroundColor Cyan
Write-Host "   Redis:    http://localhost:8081" -ForegroundColor Cyan
Write-Host "   PostgreSQL: localhost:5432" -ForegroundColor Cyan

Write-Host "`nüë§ Usu√°rios de teste:" -ForegroundColor Green
Write-Host "   Admin: admin@enso.com / admin123" -ForegroundColor Cyan
Write-Host "   Test:  test@enso.com / test123" -ForegroundColor Cyan

Write-Host "`nüìã Comandos √∫teis:" -ForegroundColor Green
Write-Host "   Parar servi√ßos: docker-compose -f docker-compose.dev.yml down" -ForegroundColor Cyan
Write-Host "   Ver logs: docker-compose -f docker-compose.dev.yml logs -f" -ForegroundColor Cyan
Write-Host "   Rebuild: docker-compose -f docker-compose.dev.yml up --build" -ForegroundColor Cyan
"@

$startScript | Out-File -FilePath "start-dev.ps1" -Encoding UTF8
Write-Host "‚úÖ Script start-dev.ps1 criado" -ForegroundColor Green

# 11. Criar script de parada
Write-Host "`nüìù Criando script de parada..." -ForegroundColor Cyan
$stopScript = @"
Write-Host "üõë Parando ambiente de desenvolvimento ENSO..." -ForegroundColor Yellow
docker-compose -f docker-compose.dev.yml down
Write-Host "‚úÖ Ambiente parado" -ForegroundColor Green
"@

$stopScript | Out-File -FilePath "stop-dev.ps1" -Encoding UTF8
Write-Host "‚úÖ Script stop-dev.ps1 criado" -ForegroundColor Green

# 12. Criar README de desenvolvimento
Write-Host "`nüìù Criando README de desenvolvimento..." -ForegroundColor Cyan
$readmeContent = @"
# Ambiente de Desenvolvimento ENSO

## üöÄ In√≠cio R√°pido

### Pr√©-requisitos
- Docker Desktop
- Node.js 18+
- Git

### Configura√ß√£o Inicial
Execute o script de setup:
```powershell
.\setup-dev.ps1
```

### Iniciar Ambiente
```powershell
.\start-dev.ps1
```

### Parar Ambiente
```powershell
.\stop-dev.ps1
```

## üåê Servi√ßos Dispon√≠veis

| Servi√ßo | URL | Descri√ß√£o |
|---------|-----|-----------|
| Frontend | http://localhost:3000 | Aplica√ß√£o React |
| Backend | http://localhost:5002 | API Node.js |
| Adminer | http://localhost:8080 | Interface PostgreSQL |
| Redis Commander | http://localhost:8081 | Interface Redis |
| PostgreSQL | localhost:5432 | Banco de dados |

## üë§ Usu√°rios de Teste

| Email | Senha | Role |
|-------|-------|------|
| admin@enso.com | admin123 | Admin |
| test@enso.com | test123 | User |

## üìã Comandos √öteis

### Docker
```bash
# Ver logs de todos os servi√ßos
docker-compose -f docker-compose.dev.yml logs -f

# Ver logs de um servi√ßo espec√≠fico
docker-compose -f docker-compose.dev.yml logs -f backend

# Rebuild e reiniciar
docker-compose -f docker-compose.dev.yml up --build

# Parar todos os servi√ßos
docker-compose -f docker-compose.dev.yml down

# Parar e remover volumes
docker-compose -f docker-compose.dev.yml down -v
```

### Desenvolvimento
```bash
# Instalar depend√™ncias do backend
npm install

# Instalar depend√™ncias do frontend
cd client && npm install

# Rodar backend em modo desenvolvimento
npm run dev

# Rodar frontend em modo desenvolvimento
cd client && npm run dev
```

## üîß Configura√ß√£o

### Vari√°veis de Ambiente
- `.env` - Configura√ß√µes do backend
- `client/.env` - Configura√ß√µes do frontend

### Banco de Dados
O banco √© inicializado automaticamente com:
- Schema: `enso_schema`
- Tabelas: users, products, inspections, inspection_plans, etc.
- Dados de exemplo inclu√≠dos

## üêõ Troubleshooting

### Problemas Comuns

1. **Porta j√° em uso**
   ```bash
   # Verificar o que est√° usando a porta
   netstat -ano | findstr :3000
   # Matar o processo
   taskkill /PID <PID> /F
   ```

2. **Docker n√£o inicia**
   - Verificar se Docker Desktop est√° rodando
   - Reiniciar Docker Desktop

3. **Banco n√£o conecta**
   ```bash
   # Verificar se PostgreSQL est√° rodando
   docker-compose -f docker-compose.dev.yml ps
   # Reiniciar apenas o banco
   docker-compose -f docker-compose.dev.yml restart postgres
   ```

4. **Depend√™ncias desatualizadas**
   ```bash
   # Rebuild completo
   docker-compose -f docker-compose.dev.yml down
   docker-compose -f docker-compose.dev.yml up --build
   ```

## üìÅ Estrutura do Projeto

```
enso/
‚îú‚îÄ‚îÄ client/                 # Frontend React
‚îú‚îÄ‚îÄ server/                 # Backend Node.js
‚îú‚îÄ‚îÄ shared/                 # C√≥digo compartilhado
‚îú‚îÄ‚îÄ migrations/             # Migra√ß√µes do banco
‚îú‚îÄ‚îÄ scripts/                # Scripts de setup
‚îú‚îÄ‚îÄ uploads/                # Arquivos enviados
‚îú‚îÄ‚îÄ docker-compose.dev.yml  # Configura√ß√£o Docker
‚îú‚îÄ‚îÄ Dockerfile.backend      # Docker do backend
‚îú‚îÄ‚îÄ client/Dockerfile.frontend # Docker do frontend
‚îî‚îÄ‚îÄ scripts/init-db.sql     # Inicializa√ß√£o do banco
```
"@

$readmeContent | Out-File -FilePath "README-DEV.md" -Encoding UTF8
Write-Host "‚úÖ README-DEV.md criado" -ForegroundColor Green

# 13. Resumo final
Write-Host "`nüéâ Configura√ß√£o conclu√≠da!" -ForegroundColor Green
Write-Host "==================================================" -ForegroundColor Green
Write-Host "`nüìã Pr√≥ximos passos:" -ForegroundColor Yellow
Write-Host "1. Execute: .\start-dev.ps1" -ForegroundColor Cyan
Write-Host "2. Acesse: http://localhost:3000" -ForegroundColor Cyan
Write-Host "3. Fa√ßa login com: admin@enso.com / admin123" -ForegroundColor Cyan
Write-Host "`nüìö Documenta√ß√£o: README-DEV.md" -ForegroundColor Yellow
Write-Host "`nüîß Scripts criados:" -ForegroundColor Yellow
Write-Host "   - start-dev.ps1 (iniciar ambiente)" -ForegroundColor Cyan
Write-Host "   - stop-dev.ps1 (parar ambiente)" -ForegroundColor Cyan
Write-Host "   - setup-dev.ps1 (reconfigurar)" -ForegroundColor Cyan

Write-Host "`n‚úÖ Ambiente de desenvolvimento configurado com sucesso!" -ForegroundColor Green
